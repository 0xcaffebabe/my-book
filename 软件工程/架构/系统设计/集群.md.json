{"content":"# 集群\n\n## 负载均衡\n\n- 高可用：当某个节点故障时，负载均衡器会将用户请求转发到另外的节点上，从而保证所有服务持续可用\n- 伸缩性：根据系统整体负载情况，可以很容易地添加或移除节点\n\n### 算法\n\n- 轮询（Round Robin）\n\n每个请求轮流发送到每个服务器上\n该算法笔记适合每个服务器性能差不多的场景\n\n- 加权轮询（Weighted Round Robbin）\n\n在轮询的基础上，根据服务器的性能差异，为服务器赋予一定的权值，性能高的服务器分配更高的权值\n权值更高的服务器接收更多的请求\n\n- 最少连接（Least Connections）\n\n将请求发送给当前最少连接数的服务器上\n\n- 加权最少连接（Weighted Least Connection）\n\n根据服务器的性能为每台服务器分配权重，再根据权重计算出每台服务器能处理的连接数\n\n- 随机算法（Random）\n\n把请求随机发送到服务器上\n\n- 源地址哈希法 (IP Hash)\n\n通过对客户端 IP 计算哈希值之后，再对服务器数量取模得到目标服务器的序号\n这样就可以保证同一ip的客户的请求都会转发到同一台服务器，这个算法可以解决分布式session问题\n\n### 转发实现\n\n- HTTP重定向\n\n负载均衡服务器使用某种负载均衡算法计算得到服务器的 IP 地址之后，将该地址写入 HTTP 重定向报文中，状态码为 302。客户端收到重定向报文之后，需要重新向服务器发起请求\n\n这样客户端需要两次请求，性能会收到一定影响\n\n![2020317145131](/assets/2020317145131.jpg)\n\n- DNS域名解析\n\nDNS 解析域名的同时使用负载均衡算法计算服务器 IP 地址\n\n优点是可以返回离用户地理位置更近的服务器\n缺点是DNS具有多级结构，DNS解析结果可能被各级缓存，修改DNS记录后，需要比较长的时间才能生效\n\n大型网站基本使用了 DNS 做为第一级负载均衡手段，然后在内部使用其它方式做第二级负载均衡\n\n![2020317145357](/assets/2020317145357.jpg)\n\n- 反向代理服务器\n\n位于源服务器前面，用户的请求需要先经过反向代理服务器才能到达源服务器\n\n反向代理服务器可能会成为性能瓶颈\n\n- 网络层\n\nnginx之类的代理服务器是工作在应用层上的，网络层上的反向代理可以直接修改数据包目的IP地址，进行转发，但在服务器的响应还是需要经过负载均衡器\n\n- 链路层\n\n在链路层根据负载均衡算法计算源服务器的 MAC 地址，并修改请求数据包的目的 MAC 地址，并进行转发\n\n通过配置源服务器的虚拟 IP 地址和负载均衡服务器的 IP 地址一致，源服务器的响应可以直接发送给客户端，不用经过负载均衡器\n\n## session管理\n\n### Sticky Session\n\n配置负载均衡器，使得一个用户的所有请求都路由到同一个服务器，这样就可以把用户的 Session 存放在该服务器中\n当该节点宕机后，该节点的所有会话数据都将丢失\n\n![202031715046](/assets/202031715046.png)\n\n### Session Replication\n\n在服务器之间进行 Session 同步操作，每个服务器都有所有用户的 Session 信息\n\n内存占用过多，且同步过程会影响性能\n\n![202031715143](/assets/202031715143.png)\n\n### Session Server\n\n使用一个单独的服务器存储 Session 数据，如可以使用mysql或者redis来实现\n\n这可以使应用服务器保持无状态，但缺点是需要对session存取代码进行改造\n\n![202031715310](/assets/202031715310.png)","commitList":[{"date":"2021-10-08T12:45:10+08:00","author":"cjiping","message":"doc开发期 构建期调整","hash":"704efe7455b7fb2fbd81ec60099191ff982e639a"},{"date":"2021-10-07T19:38:58+08:00","author":"My","message":"init","hash":"4e0456332231ba0523aa526415f9982377358870"}],"hasMoreCommit":false,"totalCommits":0}